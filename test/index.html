<!doctype html>

<head>
    <title>Bigpipe.js Test</title>
    <link rel="stylesheet" href="../bower_components/jasmine/lib/jasmine-core/jasmine.css">
    <script src="../bower_components/jasmine/lib/jasmine-core/jasmine.js"></script>
    <script src="../bower_components/jasmine/lib/jasmine-core/jasmine-html.js"></script>
    <script src="../bower_components/jasmine/lib/jasmine-core/boot.js"></script>
    <script src="../bower_components/jasmine-jsreporter-real/jasmine-jsreporter.js"></script>
    <script>
        jasmine.getEnv().addReporter(new jasmine.JSReporter2());
    </script>
    <script src="../bower_components/es6-promise/promise.js"></script>
    <script>
        ES6Promise.polyfill();
    </script>
    <script src="../lib/bigpipe.js"></script>
    <script>
        Bigpipe.debug(true);
        window.Pagelet = Bigpipe.Pagelet;
        window.pagelets = Bigpipe.pagelets;
    </script>
</head>

<body>
    <div style="height:0;">
        <div id="style-manager-test1"></div>
        <div id="style-manager-test2"></div>
        <div id="style-manager-test3"></div>
        <div id="style-manager-test4"></div>
    </div>
    <script>
        describe("Style Manager", function() {
            var styleManager = Bigpipe.styleManager;
            it("loading/unloading callback called after styles applied", function(done) {
                var target = document.getElementById('style-manager-test1');
                styleManager.load('styles/style-manager-test1/height.css').then(function() {
                    expect(getComputedStyle(target).height).toBe('10px');
                }).then(function() {
                    return styleManager.unload('styles/style-manager-test1/height.css');
                }).then(function() {
                    expect(getComputedStyle(target).height).toBe('0px');
                    done();
                });
            });

            it("Multiple styles loading", function(done) {
                var target = document.getElementById('style-manager-test2');
                styleManager.load([
                    //height.css 是个很大的文件，会在 lineHeight.css 之后完成加载
                    'styles/style-manager-test2/height.css?ttf=1000',
                    'styles/style-manager-test2/lineHeight.css'
                ]).then(function() {
                    var cssStyles = getComputedStyle(target);
                    expect(cssStyles.height).toBe('10px');
                    expect(cssStyles.lineHeight).toBe('20px');
                    // lineHeight.css 应该覆盖 height.css 中相同权重的属性
                    expect(cssStyles.fontSize).toBe('13px');
                    done();
                });
            });

            it("Cache control", function(done) {
                var target = document.getElementById('style-manager-test3');
                var originalStylesLength = document.styleSheets.length;
                styleManager.load('styles/style-manager-test3/height.css').then(function() {
                    expect(document.styleSheets.length).toBe(originalStylesLength + 1);
                }).then(function() {
                    return styleManager.load('styles/style-manager-test3/height.css');
                }).then(function() {
                    expect(getComputedStyle(target).height).toBe('10px');
                    expect(document.styleSheets.length).toBe(originalStylesLength + 1);
                }).then(function() {
                    return styleManager.unload('styles/style-manager-test3/height.css');
                }).then(function() {
                    expect(getComputedStyle(target).height).toBe('10px');
                    expect(document.styleSheets.length).toBe(originalStylesLength + 1);
                }).then(function() {
                    return styleManager.unload('styles/style-manager-test3/height.css');
                }).then(function() {
                    expect(getComputedStyle(target).height).toBe('0px');
                    expect(document.styleSheets.length).toBe(originalStylesLength);
                    done();
                });
            });

            it("Promised", function(done) {
                var originalStylesLength = document.styleSheets.length;
                var target = document.getElementById('style-manager-test4');
                Promise.all([
                    styleManager.load('styles/style-manager-test4/height.css').then(function() {
                        expect(getComputedStyle(target).height).toBe('10px');
                    }),
                    styleManager.load('styles/style-manager-test4/height.css').then(function() {
                        expect(getComputedStyle(target).height).toBe('10px');
                    })
                ]).then(function() {
                    expect(document.styleSheets.length).toBe(originalStylesLength + 1);
                    done();
                });
            });

            it("config", function(done) {
                styleManager.config({
                    urlsGenerator: function(ids) {
                        var urls = [];
                        for (var i = ids.length - 1; i >= 0; i--) {
                            urls.unshift('styles/' + ids[i]);
                        }
                        return urls;
                    }
                });
                var target = document.getElementById('style-manager-test1');
                styleManager.load('style-manager-test1/height.css').then(function() {
                    expect(getComputedStyle(target).height).toBe('10px');
                }).then(function() {
                    return styleManager.unload('style-manager-test1/height.css');
                }).then(function() {
                    expect(getComputedStyle(target).height).toBe('0px');
                    done();
                });
            });

        });
    </script>
    <script>
        describe('Script Loader', function(done) {
            var scriptLoader = Bigpipe.scriptLoader;
            it('load script', function(done) {
                //无论怎么 load，同一个 js 只会加载执行一次
                Promise.all([
                    scriptLoader.load('scripts/script-loader-test/inc.js').then(function() {
                        expect(window.scriptTestCounter).toBe(1);
                    }).then(function() {
                        return scriptLoader.load('scripts/script-loader-test/inc.js');
                    }).then(function() {
                        expect(window.scriptTestCounter).toBe(1);
                    }),

                    scriptLoader.load('scripts/script-loader-test/inc.js').then(function() {
                        expect(window.scriptTestCounter).toBe(1);
                    }),
                    scriptLoader.load('scripts/script-loader-test/inc.js').then(function() {
                        expect(window.scriptTestCounter).toBe(1);
                    })
                ]).then(done);
            });

            it("Multiple script loading", function(done) {
                scriptLoader.load([
                    'scripts/script-loader-test/mod_a.js',
                    'scripts/script-loader-test/mod_b.js'
                ]).then(function() {
                    expect(window.modA).toBe(true);
                    expect(window.modB).toBe(true);
                    done();
                });
            });

            it("config", function(done) {
                scriptLoader.config({
                    urlsGenerator: function(ids) {
                        var urls = [];
                        for (var i = ids.length - 1; i >= 0; i--) {
                            urls.unshift('scripts/' + ids[i]);
                        }
                        return urls;
                    }
                });
                scriptLoader.load('script-loader-test/inc.js').then(function() {
                    expect(window.scriptTestCounter).toBe(1);
                    done();
                });
            });
        });
    </script>
    <div style="display:none;">
        <div id="pagelet_nav"></div>
        <code class="pagelet_html" id="pagelethtml_nav">
            <!--<nav id="nav"></nav>-->
        </code>

        <div id="pagelet_outer"></div>
        <code class="pagelet_html" id="pagelethtml_outer">
            <!--outer<div id="pagelet_inner"></div>-->
        </code>
        <code class="pagelet_html" id="pagelethtml_inner">
            <!--<div>inner</div>-->
        </code>
    </div>
    <script>
        describe("Pagelet", function() {
            describe("register", function() {
                it("Basic Bigpipe.register", function(done) {
                    Bigpipe.register('nav', {
                        styles: ['nav/height.css'],
                        scripts: ['nav/height.js', 'nav/mod_b.js'],
                        initScript: 'window.c = window.navHeight + window.modB;console.log("nav\'s initScript executed")'
                    }, function(pagelet) {
                        var container = document.getElementById('pagelet_nav');
                        var htmlContainer = document.getElementById('pagelethtml_nav');
                        expect(pagelet instanceof Pagelet).toBe(true);
                        expect(container.innerHTML).toBe("<nav id=\"nav\"></nav>");
                        expect(htmlContainer).toBe(null);
                        expect(window.navHeight).toBe(2);
                        expect(window.modB).toBe(3);
                        expect(window.c).toBe(5);
                        console.log('nav\'s callback executed');
                        done();
                    });
                });
                it("Nested pagelet register", function(done) {
                    Bigpipe.register('inner', {
                        parent: 'outer',
                        styles: ['nested/inner.css'],
                        scripts: ['nested/inner.js'],
                        initScript: 'window.innerInited = true; console.log("inner\'s initScript executed")'
                    }, function(pagelet) {
                        var container = document.getElementById('pagelet_inner');
                        expect(container).not.toBe(null);
                        console.log('inner\'s callback executed');
                    });
                    window.setTimeout(function() {
                        Bigpipe.register('outer', {
                            styles: ['nested/outer.css'],
                            scripts: ['nested/outer.js'],
                            initScript: 'console.log("outer\'s initScript executed")'
                        }, function(pagelet) {
                            var container = document.getElementById('pagelet_outer');
                            expect(window.innerInited).toBe(true);
                            expect(container.innerHTML).toBe("outer<div id=\"pagelet_inner\"><div>inner</div></div>");
                            console.log('outer\'s callback executed');
                            done();
                        });
                    }, 200);
                });
            });
            it("config", function() {
                function staticUrlGenerator(ids) {
                    return ids;
                }
                Bigpipe.config({
                    getStylesUrl: staticUrlGenerator,
                    getScriptsUrl: staticUrlGenerator
                });
                expect(Bigpipe.styleManager._getUrl).toBe(staticUrlGenerator);
                expect(Bigpipe.scriptLoader._getUrl).toBe(staticUrlGenerator);
            });
        });
    </script>
</body>
